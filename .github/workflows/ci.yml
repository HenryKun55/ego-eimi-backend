name: CI - Backend

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    env:
      NODE_ENV: test
      JWT_SECRET: dummy-secret
      OPEN_API_KEY: ${{ secrets.OPEN_API_KEY }}
      QDRANT_URL: http://localhost:6333
      QDRANT_COLLECTION: document_chunks
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASS: postgres
      DB_DATABASE: ego_eimi
      USE_EMBEDDING_MOCK: true

    steps:
      - name: 📥 Checkout repo
        uses: actions/checkout@v3

      - name: 🐳 Start services via docker-compose
        run: docker-compose -f docker-compose.test.yml up -d

      - name: ⏳ Wait for Qdrant to be healthy
        run: |
          echo "Esperando Qdrant..."
          until curl -s http://localhost:6333/collections | grep -q "collections"; do
            echo "Ainda não está pronto, aguardando..."
            sleep 3
          done
          echo "Qdrant OK!"

      - name: 🔧 Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: 📦 Install dependencies
        run: bun install

      - name: 🧪 Run unit tests
        run: bun run test

      - name: 🧪 Run E2E tests
        run: bun run test:e2e
