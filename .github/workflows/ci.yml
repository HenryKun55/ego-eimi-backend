name: CI - Backend

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  backend-tests:
    runs-on: ubuntu-latest

    env:
      NODE_ENV: test
      JWT_SECRET: dummy-secret
      OPEN_API_KEY: ${{ secrets.OPEN_API_KEY }}
      QDRANT_URL: http://localhost:6333
      QDRANT_COLLECTION: document_chunks
      DB_HOST: localhost
      DB_PORT: 5432
      DB_USER: postgres
      DB_PASS: postgres
      DB_DATABASE: ego_eimi
      USE_EMBEDDING_MOCK: true

    steps:
      - name: ğŸ“¥ Checkout repo
        uses: actions/checkout@v3

      - name: ğŸ³ Start services via docker-compose
        run: docker-compose -f docker-compose.test.yml up -d

      - name: â³ Wait for Qdrant to be healthy
        run: |
          echo "Esperando Qdrant..."
          until curl -s http://localhost:6333/collections | grep -q "collections"; do
            echo "Ainda nÃ£o estÃ¡ pronto, aguardando..."
            sleep 3
          done
          echo "Qdrant OK!"

      - name: ğŸ”§ Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: ğŸ“¦ Install dependencies
        run: bun install

      - name: ğŸ§ª Run unit tests
        run: bun run test

      - name: ğŸ§ª Run E2E tests
        run: bun run test:e2e
